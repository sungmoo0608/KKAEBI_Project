<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="edu.ict.ex.goods.mapper.PriceRateMapper">

	<!-- 예금 상품 금리 VO -->
	<resultMap id="interestRateMap" type="InterestrateVO">
		<result property="goods_code" column="goods_code" />
		<result property="period_mm" column="period_mm" />
		<result property="status" column="status" />
		<result property="interest_rate" column="interest_rate" />
	</resultMap>

	<!-- 펀드 상품 기준가 VO -->
	<resultMap id="basepriceMap" type="BasepriceVO">
		<result property="goods_code" column="goods_code" />
		<result property="base_date" column="base_date" />
		<result property="status" column="status" />
		<result property="trbase_price" column="trbase_price" />
		<result property="trxbase_price" column="trxbase_price" />
	</resultMap>

	<!-- 환율 정보 VO -->
	<resultMap id="exchangeRateMap" type="ExchangerateVO">
		<result property="goods_code" column="goods_code" />
		<result property="base_date" column="base_date" />
		<result property="seq_no" column="seq_no" />
		<result property="status" column="status" />
		<result property="exchange_rate" column="exchange_rate" />
	</resultMap>

	<!-- 주가 정보 VO -->
	<resultMap id="stockpriceMap" type="StockpriceVO">
		<result property="goods_code" column="goods_code" />
		<result property="base_date" column="base_date" />
		<result property="seq_no" column="seq_no" />
		<result property="status" column="status" />
		<result property="tran_datetime" column="tran_datetime" />
		<result property="stock_price" column="stock_price" />
	</resultMap>

	<!-- 30일전 펀드 모든 상품 가격 리스트 -->
	<select id="getBasepriceList" resultMap="basepriceMap">
		<![CDATA[
			SELECT *
			FROM baseprice_his
			WHERE base_date BETWEEN TO_CHAR(SYSDATE - 30, 'YYYYMMDD') AND TO_CHAR(SYSDATE, 'YYYYMMDD')
		]]>
	</select>
	
	<!-- 지정 30일전 펀드 상품 가격 -->
	<select id="getCodeBPrice" resultMap="basepriceMap">
		<![CDATA[
			SELECT *
			FROM baseprice_his
			WHERE base_date BETWEEN TO_CHAR(SYSDATE - 30, 'YYYYMMDD') AND TO_CHAR(SYSDATE, 'YYYYMMDD')
			and goods_code = #{goods_code}
		]]>
	</select>
	
	<!-- 30일전 외환 모든 상품 가격 리스트 -->
	<select id="getExchangerateList" resultMap="exchangeRateMap">
		<![CDATA[
			SELECT goods_code,
			       base_date,
			       seq_no,
			       status,
			       exchange_rate
			  FROM (
			        SELECT goods_code,
			               base_date,
			               seq_no,
			               status,
			               exchange_rate,
			               ROW_NUMBER() OVER (PARTITION BY goods_code, base_date ORDER BY seq_no DESC) AS row_num
			          FROM exchangerate_his
			         WHERE TO_DATE(base_date, 'YYYYMMDD') >= SYSDATE - 30  -- 오늘 날짜부터 30일 전까지만
			           AND TO_DATE(base_date, 'YYYYMMDD') <= SYSDATE      -- 오늘 날짜 이후의 데이터 제외
			       )
			 WHERE row_num = 1
		]]>
	</select>
	
	<!-- 지정 30일전 외환 상품 상세 가격 -->
	<select id="getExchangeRate" resultMap="exchangeRateMap">
		<![CDATA[
			SELECT goods_code,
			       base_date,
			       seq_no,
			       status,
			       exchange_rate
			  FROM (
			        SELECT goods_code,
			               base_date,
			               seq_no,
			               status,
			               exchange_rate,
			               ROW_NUMBER() OVER (PARTITION BY goods_code, base_date ORDER BY seq_no DESC) AS row_num
			          FROM exchangerate_his
			         WHERE TO_DATE(base_date, 'YYYYMMDD') >= SYSDATE - 30  -- 오늘 날짜부터 30일 전까지만
			           AND TO_DATE(base_date, 'YYYYMMDD') <= SYSDATE      -- 오늘 날짜 이후의 데이터 제외
			       )
			 WHERE row_num = 1
			and goods_code = #{goods_code}			
			ORDER BY base_date ASC
		]]>
	</select>
	
	
	<!-- 30일전 주식 모든 상품 가격 리스트 -->
	<select id="getStockpriceList" resultMap="stockpriceMap">
		<![CDATA[
			SELECT goods_code,
			       base_date,
			       seq_no,
			       status,
			       tran_datetime,
			       stock_price
			  FROM (
			        SELECT goods_code,
			               base_date,
			               seq_no,
			               status,
			               tran_datetime,
			               stock_price,
			               ROW_NUMBER() OVER (PARTITION BY goods_code, base_date ORDER BY seq_no DESC) AS row_num
			          FROM stockprice_his
			         WHERE TO_DATE(base_date, 'YYYYMMDD') >= SYSDATE - 30 
			           AND TO_DATE(base_date, 'YYYYMMDD') <= SYSDATE
			       )
			 WHERE row_num = 1
		]]>
	</select>
	
	<!-- 지정 30일전 주식 상품 가격 -->
	<select id="getStockpirce" resultMap="stockpriceMap">
		<![CDATA[
				SELECT goods_code,
				       base_date,
				       seq_no,
				       status,
				       tran_datetime,
				       stock_price
				  FROM (
				        SELECT goods_code,
				               base_date,
				               seq_no,
				               status,
				               tran_datetime,
				               stock_price,
				               ROW_NUMBER() OVER (PARTITION BY goods_code, base_date ORDER BY seq_no DESC) AS row_num
				          FROM stockprice_his
				         WHERE TO_DATE(base_date, 'YYYYMMDD') >= SYSDATE - 30 
				           AND TO_DATE(base_date, 'YYYYMMDD') <= SYSDATE
				       )
				 WHERE row_num = 1
			and goods_code = #{goods_code}
		]]>
	</select>

</mapper>
